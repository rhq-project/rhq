<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">

  <modelVersion>4.0.0</modelVersion>

   <parent>
      <groupId>org.rhq</groupId>
      <artifactId>rhq-core-parent</artifactId>
      <version>3.0.0.GA_QA</version>
   </parent>

  <groupId>org.rhq</groupId>
  <artifactId>rhq-core-dbutils</artifactId>
  <packaging>jar</packaging>

  <name>RHQ Database Utilities</name>
  <description>Database schema setup, upgrade and other utilities</description>

  <scm>
    <connection>scm:git:ssh://git.fedorahosted.org/git/rhq.git/modules/core/dbutils</connection>
    <developerConnection>scm:git:ssh://git.fedorahosted.org/git/rhq.git/modules/core/dbutils</developerConnection>
  </scm>

  <properties>
    <scm.module.path>modules/core/dbutils/</scm.module.path>
    <db.schema.version>2.87</db.schema.version>
  </properties>

  <dependencies>

    <!-- 3rd Party Deps -->

    <dependency>
      <groupId>ant</groupId>
      <artifactId>ant</artifactId>
      <version>1.6.5</version>
    </dependency>

    <dependency>
      <groupId>ant</groupId>
      <artifactId>ant-launcher</artifactId>
      <version>1.6.5</version>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>postgresql</groupId>
      <artifactId>postgresql</artifactId>
      <!-- NOTE: The version is defined in the root POM's dependencyManagement section. -->
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
      <!-- NOTE: The version is defined in the root POM's dependencyManagement section. -->
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>net.sourceforge.jtds</groupId>
      <artifactId>jtds</artifactId>
      <!-- NOTE: The version is defined in the root POM's dependencyManagement section. -->
      <scope>test</scope>
    </dependency>

  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.codehaus.groovy.maven</groupId>
        <artifactId>gmaven-plugin</artifactId>
        <version>1.0</version>
        <dependencies>
          <dependency>
            <groupId>postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>${postgresql.version}</version>
          </dependency>
        </dependencies>
        <executions>
          <execution>
            <phase>compile</phase>
            <goals>
              <goal>execute</goal>
            </goals>
            <configuration>
              <source>
                import org.postgresql.Driver
                import groovy.sql.Sql

                if (!project.properties.dbreset) {
                  return
                }

                db = project.properties.db
                if (db == 'dev') {
                  database = project.properties['rhq.dev.ds.db-name']    
		  } 
		  // This is a bit of a temporary hack to work around 
		  // https://cvs.codehaus.org/browse/GMAVEN-46 which results in
		  // groovy scripts not being able to get the correct values of
		  // build properties that are overridden on the command line.
		  // This is being done in support of the hudson job which is
		  // trying to use a database named rhqupgrade.
		  else if (project.properties['upgrade.db']) {
                    database = 'rhqupgrade'
		  } 
		  else {
                  database = project.properties['rhq.test.ds.db-name']
                }
                project.properties.dbsetup = 'true'

                sql = Sql.newInstance(
                     "jdbc:postgresql://127.0.0.1:5432/postgres",
                     "postgres",
                     "postgres",
                     "org.postgresql.Driver")

                sql.execute("drop database if exists ${Sql.expand(database)};")
                log.info("dropped database $database")
                sql.execute("create database ${Sql.expand(database)} with owner rhqadmin;")
                log.info("created database $database")
              </source>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <artifactId>maven-surefire-plugin</artifactId>
        <configuration>
          <systemProperties>
            <property>
              <name>DatabaseTest.nofail</name>
              <value>${DatabaseTest.nofail}</value>
            </property>
            <property>
              <name>AntDatabaseTest.test-resources</name>
              <value>${basedir}/src/test/resources</value>
            </property>
          </systemProperties>
          <!-- The below is required for tests to run against Oracle. -->
          <additionalClasspathElements>
            <additionalClasspathElement>${settings.localRepository}/com/oracle/ojdbc5/${ojdbc5.version}/ojdbc5-${ojdbc5.version}.jar</additionalClasspathElement>
          </additionalClasspathElements>
        </configuration>
      </plugin>

    </plugins>
  </build>

   <profiles>
      <profile>
         <id>latest</id>
	 <activation>
            <property>
	       <name>!jon.release</name>
	    </property>
	 </activation>

	 <build>
            <plugins>
	       <plugin>
                  <artifactId>maven-antrun-plugin</artifactId>
                  <executions>
                     <execution>
                        <phase>process-classes</phase>
                        <configuration>
                           <tasks>
                              <!-- generate the I18N resource bundles -->
                              <taskdef name="i18n" classpathref="maven.runtime.classpath" classname="mazz.i18n.ant.I18NAntTask" />

                              <i18n outputdir="${project.build.outputDirectory}" defaultlocale="en" verbose="false" append="false" verify="true">
                              <classpath refid="maven.runtime.classpath" />
                              <classfileset dir="${project.build.outputDirectory}">
                                 <include name="**/*I18NResourceKeys.class" />
                              </classfileset>
                           </i18n>
                       </tasks>
                    </configuration>
                    <goals>
                       <goal>run</goal>
                   </goals>
                </execution>

                <execution>
                   <id>dbsetup-worker</id>
                   <phase>test</phase>
                   <configuration>
                      <tasks>
                         <property name="settings.localRepository" location="${user.home}/.m2/repository}" />

                         <condition property="rhq.ds.type-mapping" value="${rhq.dev.ds.type-mapping}" else="${rhq.test.ds.type-mapping}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.connection-url" value="${rhq.dev.ds.connection-url}" else="${rhq.test.ds.connection-url}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.user-name" value="${rhq.dev.ds.user-name}" else="${rhq.test.ds.user-name}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.password" value="${rhq.dev.ds.password}" else="${rhq.test.ds.password}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <ant antfile="${basedir}/src/main/scripts/dbsetup-build.xml">
                            <property name="settings.localRepository" value="${settings.localRepository}" />
                            <property name="ojdbc5.version" value="${ojdbc5.version}" />
                            <property name="postgresql.version" value="${postgresql.version}" />
                            <property name="h2.version" value="${h2.version}" />
                            <property name="jtds.version" value="${jtds.version}" />
                            <property name="task.classpath.property" refid="maven.test.classpath" />
                            <property name="rhq.ds.type-mapping" value="${rhq.ds.type-mapping}" />
                            <property name="rhq.ds.connection-url" value="${rhq.ds.connection-url}" />
                            <property name="rhq.ds.user-name" value="${rhq.ds.user-name}" />
                            <property name="rhq.ds.password" value="${rhq.ds.password}" />
                            <property name="project.version" value="${project.version}" />
                            <property name="db.schema.version" value="${db.schema.version}" />
                            <property name="dbsetup" value="${dbsetup}" />
                            <property name="dbsetup-uninstall" value="${dbsetup-uninstall}" />
                            <property name="dbsetup-upgrade" value="${dbsetup-upgrade}" />
                            <property name="dbsetup-export" value="${dbsetup-export}" />
                         </ant>
                      </tasks>
                   </configuration>
                   <goals>
                      <goal>run</goal>
                  </goals>
               </execution>

               <execution>
                  <id>generate-dbsetup-dbupgrade-xml-files</id>
                  <phase>process-classes</phase>
                  <configuration>
                     <tasks>
                        <property name="settings.localRepository" location="${user.home}/.m2/repository}" />

			<condition property="rhq.ds.type-mapping" value="${rhq.dev.ds.type-mapping}" else="${rhq.test.ds.type-mapping}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.connection-url" value="${rhq.dev.ds.connection-url}" else="${rhq.test.ds.connection-url}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.user-name" value="${rhq.dev.ds.user-name}" else="${rhq.test.ds.user-name}">
                            <equals arg1="${db}" arg2="dev" />
                         </condition>

                         <condition property="rhq.ds.password" value="${rhq.dev.ds.password}" else="${rhq.test.ds.password}">
                            <equals arg1="${db}" arg2="dev" />
		         </condition>

                        <ant antfile="${basedir}/src/main/scripts/dbsetup-build.xml" target="dbsetup-combine">
                           <property name="settings.localRepository" value="${settings.localRepository}" />
                           <property name="ojdbc5.version" value="${ojdbc5.version}" />
                           <property name="postgresql.version" value="${postgresql.version}" />
                           <property name="h2.version" value="${h2.version}" />
                           <property name="jtds.version" value="${jtds.version}" />
                           <property name="task.classpath.property" refid="maven.test.classpath" />
                           <property name="rhq.ds.type-mapping" value="${rhq.ds.type-mapping}" />
                           <property name="rhq.ds.connection-url" value="${rhq.ds.connection-url}" />
                           <property name="rhq.ds.user-name" value="${rhq.ds.user-name}" />
                           <property name="rhq.ds.password" value="${rhq.ds.password}" />
                           <property name="project.version" value="${project.version}" />
                           <property name="db.schema.version" value="${db.schema.version}" />
                       </ant>
                    </tasks>
                 </configuration>
                 <goals>
                    <goal>run</goal>
                </goals>
             </execution>
   
             <execution>
               <!--
                  This execution will abort the build if the database schema is not up to date.
                  If you want the build to continue, regardless of your currently installed schema,
                  then pass -Ddbsetup-do-not-check-schema to the mvn command line.
               -->
               <id>test-db-schema-version</id>
               <phase>test</phase>
            <configuration>
              <tasks>
	         <property name="settings.localRepository" location="${user.home}/.m2/repository}" />

		 <condition property="rhq.ds.type-mapping" value="${rhq.dev.ds.type-mapping}" else="${rhq.test.ds.type-mapping}">
                    <equals arg1="${db}" arg2="dev" />
                 </condition>

                 <condition property="rhq.ds.connection-url" value="${rhq.dev.ds.connection-url}" else="${rhq.test.ds.connection-url}">
                    <equals arg1="${db}" arg2="dev" />
                 </condition>

                 <condition property="rhq.ds.user-name" value="${rhq.dev.ds.user-name}" else="${rhq.test.ds.user-name}">
                    <equals arg1="${db}" arg2="dev" />
                 </condition>

                 <condition property="rhq.ds.password" value="${rhq.dev.ds.password}" else="${rhq.test.ds.password}">
                    <equals arg1="${db}" arg2="dev" />
		 </condition>

                <condition property="rhq.ds.driver-class" value="${rhq.dev.ds.driver-class}" else="${rhq.test.ds.driver-class}">
                   <equals arg1="${db}" arg2="dev" />
                </condition>

                <ant antfile="${basedir}/src/main/scripts/dbsetup-build.xml" target="dbsetup-check-schema">
                  <property name="settings.localRepository" value="${settings.localRepository}" />
                  <property name="ojdbc5.version" value="${ojdbc5.version}" />
                  <property name="postgresql.version" value="${postgresql.version}" />
                  <property name="h2.version" value="${h2.version}" />
                  <property name="jtds.version" value="${jtds.version}" />
                  <property name="task.classpath.property" refid="maven.test.classpath" />
                  <property name="rhq.ds.type-mapping" value="${rhq.ds.type-mapping}" />
                  <property name="rhq.ds.connection-url" value="${rhq.ds.connection-url}" />
                  <property name="rhq.ds.user-name" value="${rhq.ds.user-name}" />
                  <property name="rhq.ds.password" value="${rhq.ds.password}" />
                  <property name="project.version" value="${project.version}" />
                  <property name="db.schema.version" value="${db.schema.version}" />
                  <property name="rhq.ds.driver-class" value="${rhq.ds.driver-class}" />
                  <property name="dbsetup-do-not-check-schema" value="${dbsetup-do-not-check-schema}" />
                </ant>
              </tasks>
            </configuration>
            <goals>
              <goal>run</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
	    </plugins>
	 </build>
      </profile>

      <profile>
         <id>jon.release</id>
	 <activation>
            <property>
	       <name>jon.release</name>
	    </property>
	 </activation>
	 <build>
            <plugins>
	       <plugin>
                  <artifactId>maven-antrun-plugin</artifactId>
                  <executions>
                     <execution>
                       <id>generate-schema</id>
	               <phase>test</phase>
	               <configuration>
                          <tasks>
		             <property name="settings.localRepository" location="${user.home}/.m2/repository}" />

			     <condition property="rhq.ds.type-mapping" value="${rhq.dev.ds.type-mapping}" else="${rhq.test.ds.type-mapping}">
                               <equals arg1="${db}" arg2="dev" />
                             </condition>

                             <condition property="rhq.ds.connection-url" value="${rhq.dev.ds.connection-url}" else="${rhq.test.ds.connection-url}">
                               <equals arg1="${db}" arg2="dev" />
                             </condition>

                             <condition property="rhq.ds.user-name" value="${rhq.dev.ds.user-name}" else="${rhq.test.ds.user-name}">
                               <equals arg1="${db}" arg2="dev" />
                             </condition>

                            <condition property="rhq.ds.password" value="${rhq.dev.ds.password}" else="${rhq.test.ds.password}">
                               <equals arg1="${db}" arg2="dev" />
                            </condition>

                             <ant antfile="${basedir}/src/main/scripts/dbsetup-build.xml" target="create-release-schema">
                                <property name="settings.localRepository" value="${settings.localRepository}" />
                                <property name="ojdbc5.version" value="${ojdbc5.version}" />
                                <property name="postgresql.version" value="${postgresql.version}" />
                                <property name="h2.version" value="${h2.version}" />
                                <property name="jtds.version" value="${jtds.version}" />
                                <property name="task.classpath.property" refid="maven.test.classpath" />
                                <property name="rhq.ds.type-mapping" value="${rhq.ds.type-mapping}" />
                                <property name="rhq.ds.connection-url" value="${rhq.ds.connection-url}" />
                                <property name="rhq.ds.user-name" value="${rhq.ds.user-name}" />
                                <property name="rhq.ds.password" value="${rhq.ds.password}" />
                                <property name="project.version" value="${project.version}" />
                                <property name="db.schema.version" value="${db.schema.version}" />
				<property name="jon.release" value="${jon.release}" />
                             </ant>
                          </tasks>
            	       </configuration>
           	       <goals>
                          <goal>run</goal>
	               </goals>
         	     </execution>
                  </executions>
               </plugin>
	    </plugins>
         </build>
      </profile>

      <profile>
         <id>dev</id>

         <properties>
            <rhq.rootDir>../../..</rhq.rootDir>
            <rhq.containerDir>${rhq.rootDir}/${rhq.defaultDevContainerPath}</rhq.containerDir>
            <rhq.deploymentDir>${rhq.containerDir}/jbossas/server/default/deploy/${rhq.earName}/lib</rhq.deploymentDir>
         </properties>

         <build>
           <plugins>

               <plugin>
                 <artifactId>maven-antrun-plugin</artifactId>
                 <version>1.1</version>
                 <executions>

                     <execution>
                        <id>deploy</id>
                        <phase>compile</phase>
                        <configuration>
                          <tasks>
                            <mkdir dir="${rhq.deploymentDir}" />
                            <property name="deployment.file" location="${rhq.deploymentDir}/${project.build.finalName}.jar" />
                            <echo>*** Updating ${deployment.file}...</echo>
                            <jar destfile="${deployment.file}" basedir="${project.build.outputDirectory}" />
                          </tasks>
                        </configuration>
                        <goals>
                          <goal>run</goal>
                        </goals>
                     </execution>

                     <execution>
                        <id>undeploy</id>
                        <phase>clean</phase>
                        <configuration>
                          <tasks>
                            <property name="deployment.file" location="${rhq.deploymentDir}/${project.build.finalName}.jar" />
                            <echo>*** Deleting ${deployment.file}...</echo>
                            <delete file="${deployment.file}" />
                          </tasks>
                        </configuration>
                        <goals>
                          <goal>run</goal>
                        </goals>
                     </execution>

                   </executions>
               </plugin>

           </plugins>
         </build>
      </profile>
   </profiles>

   <pluginRepositories>
      <pluginRepository>
         <id>codehaus-snapshots</id>
	 <name>codehaus snapshots</name>
	 <url>http://snapshots.repository.codehaus.org</url>
	 <snapshots>
            <enabled>true</enabled>
	 </snapshots>
      </pluginRepository>
   </pluginRepositories>

</project>

