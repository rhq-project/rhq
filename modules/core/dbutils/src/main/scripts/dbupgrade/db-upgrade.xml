<?xml version="1.0"?>

<project name="db-upgrade" default="upgrade" basedir=".">

<!--
This target upgrades a database schema.  The parameters that it accepts are:
  jdbc.url              = the jdbc url of the database to upgrade
  jdbc.user             = the user to connect to the database as
  jdbc.password         = the database user's password
  target.schema.version = the schema version to upgrade to. If this is omitted
                          then the schema is upgraded to the latest version.

This target assumes that the taskdefs for the dbupgrade ant task have already been defined.
-->

<target name="upgrade">

<echo>
DB Upgrade:
   JDBC URL: ${jdbc.url}
   JDBC User: ${jdbc.user}
   Update Version: ${target.schema.version}
</echo>

<dbupgrade
   jdbcUrl="${jdbc.url}"
   jdbcUser="${jdbc.user}"
   jdbcPassword="${jdbc.password}"
   valueColumn="PROPERTY_VALUE"
   table="RHQ_SYSTEM_CONFIG"
   keyColumn="PROPERTY_KEY"
   keyMatch="DB_SCHEMA_VERSION"
   targetSchemaVersion="${target.schema.version}">

    <schemaSpec version="2.0">
        <!-- Empty initial schema to avoid install failure on default latest schema version -->
    </schemaSpec>
	
    <schemaSpec version="2.1">
        <!-- Keep the columnType VARCHAR2, but increase size;
            (see note for RHQ_ALERT_CONDITION table in alert-schema.xml for more info) -->
        <schema-alterColumn
            table="RHQ_ALERT_CONDITION"
            column="OPTION_STATUS" 
            columnType="VARCHAR2"
            precision="256" />
    </schemaSpec>
	
    <schemaSpec version="2.2">
        <!-- RHQ-481 make resource names longer -->
        <schema-alterColumn
            table="RHQ_RESOURCE"
            column="NAME" 
            columnType="VARCHAR2"
            precision="500" />
    </schemaSpec>

    <schemaSpec version="2.3">
        <!-- RHQ-666 - Don't require resource name at creation time -->
        <schema-alterColumn
            table="RHQ_CREATE_RES_HIST"
            column="CREATED_RESOURCE_NAME"
            columnType="VARCHAR2"
            precision="500" />
    </schemaSpec>

   <!-- RHQ-669 - Add metadata to package type to indicate architecture support -->
   <schemaSpec version="2.4">
        <schema-addColumn
            table="RHQ_PACKAGE_TYPE"
            column="SUPPORTS_ARCHITECTURE"
            columnType="BOOLEAN" />

        <schema-directSQL>
            <statement desc="Updating existing package types with default for SUPPORTS_ARCHITECTURE flag">
                UPDATE RHQ_PACKAGE_TYPE SET SUPS_ARCHITECTURE = FALSE
            </statement>
        </schema-directSQL>

        <schema-alterColumn
           table="RHQ_PACKAGE_TYPE"
           column="SUPPORTS_ARCHITECTURE"
           nullable="FALSE" />

   </schemaSpec>

   <!-- RHQ-176 - Add notes column to content requests -->
   <schemaSpec version="2.5">
        <schema-addColumn
            table="RHQ_CONTENT_REQ"
            column="NOTES"
            columnType="VARCHAR2"
            precision="512" />
   </schemaSpec>

   <!-- rhq-488 - RHQ High Availability / Failover Support -->
   <schemaSpec version="2.6">

        <!-- RHQ_AFFINITY_GROUP -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_AFFINITY_GROUP">
                  CREATE TABLE RHQ_AFFINITY_GROUP ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_AFFINITY_GROUP" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_AFFINITY_GROUP_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_AFFINITY_GROUP">
                ALTER TABLE RHQ_AFFINITY_GROUP ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_AFFINITY_GROUP" column="NAME" columnType="VARCHAR2" precision="255"/>
        <schema-alterColumn table="RHQ_AFFINITY_GROUP" column="NAME" nullable="FALSE"/>

        <!-- RHQ_SERVER -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_SERVER">
                  CREATE TABLE RHQ_SERVER ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_SERVER" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_SERVER_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_SERVER">
                ALTER TABLE RHQ_SERVER ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_SERVER" column="NAME" columnType="VARCHAR2" precision="255"/>
        <schema-alterColumn table="RHQ_SERVER" column="NAME" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_SERVER" column="ADDRESS" columnType="VARCHAR2" precision="255"/>
        <schema-alterColumn table="RHQ_SERVER" column="ADDRESS" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_SERVER" column="PORT" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_SERVER" column="PORT" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_SERVER" column="SECURE_PORT" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_SERVER" column="SECURE_PORT" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_SERVER" column="CTIME" columnType="LONG" />
        <schema-alterColumn table="RHQ_SERVER" column="CTIME" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_SERVER" column="AFFINITY_GROUP_ID" columnType="INTEGER" />
        <schema-directSQL>
             <statement desc="Creating RHQ_SERVER foreign key relation to RHQ_AFFINITY_GROUP">
                  ALTER TABLE RHQ_SERVER 
                  ADD CONSTRAINT RHQ_SERVER_AFFINITY_GROUP_ID_FKEY 
                  FOREIGN KEY (AFFINITY_GROUP_ID)
                  REFERENCES RHQ_AFFINITY_GROUP (ID)
             </statement>
        </schema-directSQL>

        <!-- RHQ_AGENT modifications -->
   	    <schema-addColumn   table="RHQ_AGENT" column="AFFINITY_GROUP_ID" columnType="INTEGER" />
        <schema-directSQL>
             <statement desc="Creating RHQ_AGENT foreign key relation to RHQ_AFFINITY_GROUP">
                  ALTER TABLE RHQ_AGENT 
                  ADD CONSTRAINT RHQ_AGENT_AFFINITY_GROUP_ID_FKEY 
                  FOREIGN KEY (AFFINITY_GROUP_ID)
                  REFERENCES RHQ_AFFINITY_GROUP (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_AGENT" column="SERVER_ID" columnType="INTEGER" />
        <schema-directSQL>
             <statement desc="Creating RHQ_AGENT foreign key relation to RHQ_SERVER">
                  ALTER TABLE RHQ_AGENT 
                  ADD CONSTRAINT RHQ_AGENT_SERVER_ID_FKEY 
                  FOREIGN KEY (SERVER_ID)
                  REFERENCES RHQ_SERVER (ID)
             </statement>
        </schema-directSQL>

        <!-- RHQ_PARTITION_EVENT -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_PARTITION_EVENT">
                  CREATE TABLE RHQ_PARTITION_EVENT ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_PARTITION_EVENT" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_PARTITION_EVENT_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_PARTITION_EVENT">
                ALTER TABLE RHQ_PARTITION_EVENT ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_PARTITION_EVENT" column="SUBJECT_NAME" columnType="VARCHAR2" precision="255"/>
        <schema-alterColumn table="RHQ_PARTITION_EVENT" column="SUBJECT_NAME" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_PARTITION_EVENT" column="EVENT_TYPE" columnType="VARCHAR2" precision="50"/>
        <schema-alterColumn table="RHQ_PARTITION_EVENT" column="EVENT_TYPE" nullable="FALSE"/>
        <schema-addColumn   table="RHQ_PARTITION_EVENT" column="CTIME" columnType="LONG" />
        <schema-alterColumn table="RHQ_PARTITION_EVENT" column="CTIME" nullable="FALSE"/>

        <!-- RHQ_PARTITION_DETAILS -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_PARTITION_DETAILS">
                  CREATE TABLE RHQ_PARTITION_DETAILS ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_PARTITION_DETAILS" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_PARTITION_DETAILS_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_PARTITION_DETAILS">
                ALTER TABLE RHQ_PARTITION_DETAILS ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_PARTITION_DETAILS" column="PARTITION_EVENT_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_PARTITION_DETAILS" column="PARTITION_EVENT_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_PARTITION_DETAILS foreign key relation to RHQ_PARTITION_EVENT">
                  ALTER TABLE RHQ_PARTITION_DETAILS 
                  ADD CONSTRAINT RHQ_PARTITION_DETAILS_EVENT_ID_FKEY 
                  FOREIGN KEY (PARTITION_EVENT_ID)
                  REFERENCES RHQ_PARTITION_EVENT (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_PARTITION_DETAILS" column="AGENT_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_PARTITION_DETAILS" column="AGENT_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_PARTITION_DETAILS foreign key relation to RHQ_AGENT">
                  ALTER TABLE RHQ_PARTITION_DETAILS 
                  ADD CONSTRAINT RHQ_PARTITION_DETAILS_AGENT_ID_FKEY 
                  FOREIGN KEY (AGENT_ID)
                  REFERENCES RHQ_AGENT (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_PARTITION_DETAILS" column="SERVER_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_PARTITION_DETAILS" column="SERVER_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_PARTITION_DETAILS foreign key relation to RHQ_SERVER">
                  ALTER TABLE RHQ_PARTITION_DETAILS 
                  ADD CONSTRAINT RHQ_PARTITION_DETAILS_SERVER_ID_FKEY 
                  FOREIGN KEY (SERVER_ID)
                  REFERENCES RHQ_SERVER (ID)
             </statement>
        </schema-directSQL>

        <!-- RHQ_FAILOVER_LIST -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_FAILOVER_LIST">
                  CREATE TABLE RHQ_FAILOVER_LIST ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_FAILOVER_LIST" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_FAILOVER_LIST_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_FAILOVER_LIST">
                ALTER TABLE RHQ_FAILOVER_LIST ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_LIST" column="PARTITION_EVENT_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_FAILOVER_LIST" column="PARTITION_EVENT_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_FAILOVER_LIST foreign key relation to RHQ_PARTITION_EVENT">
                  ALTER TABLE RHQ_FAILOVER_LIST 
                  ADD CONSTRAINT RHQ_FAILOVER_LIST_EVENT_ID_FKEY 
                  FOREIGN KEY (PARTITION_EVENT_ID)
                  REFERENCES RHQ_PARTITION_EVENT (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_LIST" column="AGENT_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_FAILOVER_LIST" column="AGENT_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_FAILOVER_LIST foreign key relation to RHQ_AGENT">
                  ALTER TABLE RHQ_FAILOVER_LIST 
                  ADD CONSTRAINT RHQ_FAILOVER_LIST_AGENT_ID_FKEY 
                  FOREIGN KEY (AGENT_ID)
                  REFERENCES RHQ_AGENT (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_LIST" column="CTIME" columnType="LONG" />
        <schema-alterColumn table="RHQ_FAILOVER_LIST" column="CTIME" nullable="FALSE"/>

        <!-- RHQ_FAILOVER_DETAILS -->
        <schema-directSQL>
             <statement desc="Creating table RHQ_FAILOVER_DETAILS">
                  CREATE TABLE RHQ_FAILOVER_DETAILS ( ID INTEGER )
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_FAILOVER_DETAILS" column="ID" nullable="FALSE" />
        <schema-createSequence name="RHQ_FAILOVER_DETAILS_ID_SEQ" initial="10001"/>
        <schema-directSQL>
            <statement desc="Creating primary key for RHQ_FAILOVER_DETAILS">
                ALTER TABLE RHQ_FAILOVER_DETAILS ADD PRIMARY KEY ( ID )
            </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_DETAILS" column="FAILOVER_LIST_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_FAILOVER_DETAILS" column="FAILOVER_LIST_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_FAILOVER_DETAILS foreign key relation to FAILOVER_LIST_ID">
                  ALTER TABLE RHQ_FAILOVER_DETAILS 
                  ADD CONSTRAINT RHQ_FAILOVER_DETAILS_LIST_ID_FKEY 
                  FOREIGN KEY (FAILOVER_LIST_ID)
                  REFERENCES RHQ_FAILOVER_LIST (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_DETAILS" column="SERVER_ID" columnType="INTEGER" />
        <schema-alterColumn table="RHQ_FAILOVER_DETAILS" column="SERVER_ID" nullable="FALSE"/>
        <schema-directSQL>
             <statement desc="Creating RHQ_FAILOVER_DETAILS foreign key relation to RHQ_SERVER">
                  ALTER TABLE RHQ_FAILOVER_DETAILS 
                  ADD CONSTRAINT RHQ_FAILOVER_DETAILS_SERVER_ID_FKEY 
                  FOREIGN KEY (SERVER_ID)
                  REFERENCES RHQ_SERVER (ID)
             </statement>
        </schema-directSQL>
        <schema-addColumn   table="RHQ_FAILOVER_DETAILS" column="CTIME" columnType="LONG" />
        <schema-alterColumn table="RHQ_FAILOVER_DETAILS" column="CTIME" nullable="FALSE"/>

   </schemaSpec>

   <schemaSpec version="2.7">
        <schema-addColumn   table="RHQ_AGENT" column="STATUS" columnType="INTEGER" />
        <schema-directSQL>
             <statement desc="Updating existing agents with default STATUS flag">
                 UPDATE RHQ_AGENT SET STATUS = 0
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_AGENT" column="STATUS" nullable="TRUE" default="0" />
   </schemaSpec>

   <schemaSpec version="2.8">
        <schema-addColumn   table="RHQ_SERVER" column="OPERATION_MODE" columnType="VARCHAR2" precision="32"/>
        <schema-directSQL>
             <statement desc="Updating existing servers with default OPERATION_MODE flag">
                 UPDATE RHQ_SERVER SET OPERATION_MODE = 'NORMAL'
             </statement>
        </schema-directSQL>
        <schema-alterColumn table="RHQ_SERVER" column="OPERATION_MODE" nullable="FALSE"/>

        <schema-directSQL>
            <statement desc="Creating RHQ_SERVER unique constraint on NAME">
                CREATE UNIQUE INDEX rhq_server_name_unique
                ON rhq_server (name);
            </statement>
        </schema-directSQL>
   </schemaSpec>

   <schemaSpec version="2.9">
      <schema-addColumn table="RHQ_FAILOVER_DETAILS" column="ORDINAL" columnType="INTEGER" />
   </schemaSpec>

   <schemaSpec version="2.10">
      <schema-deleteColumn table="RHQ_FAILOVER_DETAILS" column="CTIME" />
   </schemaSpec>

   <schemaSpec version="2.11">
      <schema-alterColumn table="RHQ_ALERT_NOTIFICATION" column="ALERT_DEFINITION_ID" nullable="TRUE"/>
   </schemaSpec>

   <schemaSpec version="2.12">
      <schema-deleteColumn table="RHQ_SERVER" column="PORT" />
      <schema-deleteColumn table="RHQ_SERVER" column="SECURE_PORT" />

      <schema-addColumn table="RHQ_SERVER" column="BIND_PORT" columnType="INTEGER"/>
      <schema-directSQL>
	     <statement desc="Updating existing servers with default BIND_PORT=7080">
	        UPDATE RHQ_SERVER SET BIND_PORT = 7080
	     </statement>
	  </schema-directSQL>
	  <schema-alterColumn table="RHQ_SERVER" column="BIND_PORT" nullable="FALSE"/>

	  <schema-addColumn table="RHQ_SERVER" column="TRANSPORT" columnType="VARCHAR2" precision="32"/>
      <schema-directSQL>
        <statement desc="Updating existing servers with default TRANSPORT=servlet">
            UPDATE RHQ_SERVER SET TRANSPORT = 'servlet'
         </statement>
      </schema-directSQL>
	  <schema-alterColumn table="RHQ_SERVER" column="TRANSPORT" nullable="FALSE"/>

	  <schema-addColumn table="RHQ_SERVER" column="TRANSPORT_PARAMS" columnType="VARCHAR2" precision="512"/>
	  <schema-directSQL>
	      <statement desc="Updating existing servers with default TRANSPORT_PARAMS=/jboss-remoting-servlet-invoker/ServerInvokerServlet">
	        UPDATE RHQ_SERVER SET TRANSPORT_PARAMS = '/jboss-remoting-servlet-invoker/ServerInvokerServlet'
	      </statement>
	  </schema-directSQL>
	  <schema-alterColumn table="RHQ_SERVER" column="TRANSPORT_PARAMS" nullable="FALSE"/>
	   	
	  <schema-addColumn table="RHQ_SERVER" column="COMPUTE_POWER" columnType="INTEGER"/>
	  <schema-directSQL>
	     <statement desc="Updating existing servers with default COMPUTE_POWER=1">
	            UPDATE RHQ_SERVER SET COMPUTE_POWER = 1
	     </statement>
	  </schema-directSQL>
	  <schema-alterColumn table="RHQ_SERVER" column="COMPUTE_POWER" nullable="FALSE"/>

   </schemaSpec>
	
	<schemaSpec version="2.13">
	   <schema-deleteColumn table="RHQ_SERVER" column="BIND_PORT" />
	   <schema-deleteColumn table="RHQ_SERVER" column="TRANSPORT" />
	   <schema-deleteColumn table="RHQ_SERVER" column="TRANSPORT_PARAMS" />   	

	   <schema-addColumn table="RHQ_SERVER" column="PORT" columnType="INTEGER"/>
	   <schema-directSQL>
	      <statement desc="Updating existing servers with default PORT=7080">
	            UPDATE RHQ_SERVER SET PORT = 7080
	      </statement>
	   </schema-directSQL>
	   <schema-alterColumn table="RHQ_SERVER" column="PORT" nullable="FALSE"/>

	   <schema-addColumn table="RHQ_SERVER" column="SECURE_PORT" columnType="INTEGER"/>
	   <schema-directSQL>
	      <statement desc="Updating existing servers with default SECURE_PORT=7443">
	         UPDATE RHQ_SERVER SET SECURE_PORT = 7443
	      </statement>
	   </schema-directSQL>
	   <schema-alterColumn table="RHQ_SERVER" column="SECURE_PORT" nullable="FALSE"/>

	   </schemaSpec>
	
</dbupgrade>

</target>

</project>
