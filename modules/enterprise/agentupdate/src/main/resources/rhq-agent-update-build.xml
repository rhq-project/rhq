<?xml version="1.0" encoding="UTF-8"?>

<project name="rhq-agent-update" default="start" basedir=".">

   <!-- this will back up the current agent, in case it needs to be recovered -->
   <!-- this is a standalone target that the AgentUpdate will call when it needs to backup the agent -->
   <target name="backup-agent">
      <echo>=== BACKING UP CURRENT AGENT ===</echo>
      <echo>From: ${rhq.agent.update.update-agent-dir}</echo>
      <echo>To: ${java.io.tmpdir}/rhq-agent-update-backup</echo>
      <delete dir="${java.io.tmpdir}/rhq-agent-update-backup" />
      <copy todir="${java.io.tmpdir}/rhq-agent-update-backup">
        <fileset dir="${rhq.agent.update.update-agent-dir}"/>
      </copy>
      <echo>=== BACKUP OF CURRENT AGENT COMPLETE ===</echo>
   </target>

   <!-- this will restore a backed up agent -->
   <!-- this is a standalone target that the AgentUpdate will call when it needs to restore the agent -->
   <target name="restore-agent">
      <echo>=== RESTORING OLD AGENT ===</echo>
      <echo>From: ${java.io.tmpdir}/rhq-agent-update-backup</echo>
      <echo>To: ${rhq.agent.update.update-agent-dir}</echo>
      <delete dir="${rhq.agent.update.update-agent-dir}" />
      <copy todir="${rhq.agent.update.update-agent-dir}" overwrite="true">
        <fileset dir="${java.io.tmpdir}/rhq-agent-update-backup"/>
      </copy>
      <chmod dir="${rhq.agent.update.update-agent-dir}/bin" perm="ug+rx" includes="*.sh"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.s0"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.sl"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.dylib"/>
      <echo>=== RESTORE OF OLD AGENT COMPLETE ===</echo>
   </target>

   <!-- the initial target that logs some basic information, then performs the install or update -->
   <target name="start" depends="header, verify, install, update">
   </target>

   <!-- performs a base install - this does not attempt to upgrade an agent; this provisions a fresh new agent -->
   <target name="install" unless="rhq.agent.update.update-flag">
      <unjar src="${rhq.agent.update.jar-file}"
             dest="${basedir}">
         <patternset>
             <include name="rhq-enterprise-agent-${rhq-agent.latest.version}.zip"/>
         </patternset>
      </unjar>
      <unzip src="${basedir}/rhq-enterprise-agent-${rhq-agent.latest.version}.zip"
             dest="${rhq.agent.update.install-agent-dir}"/>
      <delete file="${basedir}/rhq-enterprise-agent-${rhq-agent.latest.version}.zip"
              failonerror="false"/>
      <echo>Agent version ${rhq-agent.latest.version} (build number=${rhq-agent.latest.build-number}) has been installed to ${rhq.agent.update.install-agent-dir}</echo>
   </target>

   <!-- upgrades an existing agent -->
   <target name="update" if="rhq.agent.update.update-flag">
      <!-- we build up the new, updated agent in the update-### subdirectory
           only when we feel we successfully have a complete agent will we attempt to
           move it in the current agent's place -->
      <property name="_update.tmp.dir.name" value="update-${rhq-agent.latest.build-number}" />
      <property name="_update.tmp.dir" location="${rhq.agent.update.update-agent-dir}/${_update.tmp.dir.name}" />
      <unjar src="${rhq.agent.update.jar-file}"
             dest="${_update.tmp.dir}">
         <patternset>
             <include name="rhq-enterprise-agent-${rhq-agent.latest.version}.zip"/>
         </patternset>
      </unjar>
      <unzip src="${_update.tmp.dir}/rhq-enterprise-agent-${rhq-agent.latest.version}.zip"
             dest="${_update.tmp.dir}"/>
      <delete file="${_update.tmp.dir}/rhq-enterprise-agent-${rhq-agent.latest.version}.zip"
              failonerror="false"/>

      <!-- at this point, we have the new but raw agent extracted to the ${_update.tmp.dir}/rhq-agent -->
      <!-- the old, existing agent (the one we are upgrading) is at ${rhq.agent.update.update-agent-dir} -->

      <!-- if there are plugins, keep them -->
      <copy todir="${_update.tmp.dir}/rhq-agent/plugins">
        <fileset dir="${rhq.agent.update.update-agent-dir}/plugins"/>
      </copy>

      <!-- if there is a failover list, keep it -->
      <copy file="${rhq.agent.update.update-agent-dir}/data/failover-list.dat"
            tofile="${_update.tmp.dir}/rhq-agent/data/failover-list.dat"
            failonerror="false" />

      <!-- if there are any Windows wrapper environment or include files, copy them -->
      <copy todir="${_update.tmp.dir}/rhq-agent/bin/wrapper">
         <fileset dir="${rhq.agent.update.update-agent-dir}/bin/wrapper">
            <include name="*.env"/>
            <include name="*.inc"/>
         </fileset>
      </copy>

      <!-- copy any custom launch scripts (if we copy, we lose our UNIX +x permission bits) -->
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/bin"
                        newdir="${_update.tmp.dir}/rhq-agent/bin"
                        filename="rhq-agent-env.bat" keep="old" backupextension=".default" failonerror="false" />
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/bin"
                        newdir="${_update.tmp.dir}/rhq-agent/bin"
                        filename="rhq-agent-env.sh" keep="old" backupextension=".default" failonerror="false" />
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/bin"
                        newdir="${_update.tmp.dir}/rhq-agent/bin"
                        filename="rhq-agent-wrapper.bat" keep="old" backupextension=".default" failonerror="false" />
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/bin"
                        newdir="${_update.tmp.dir}/rhq-agent/bin"
                        filename="rhq-agent-wrapper.sh" keep="old" backupextension=".default" failonerror="false" />
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/bin/wrapper"
                        newdir="${_update.tmp.dir}/rhq-agent/bin/wrapper"
                        filename="rhq-agent-wrapper.conf" keep="old" backupextension=".default" failonerror="false" />

      <!-- copy over the agent-configuration and log4j xml files, but rename them so they do not take effect -->
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/conf"
                        newdir="${_update.tmp.dir}/rhq-agent/conf"
                        filename="agent-configuration.xml" keep="new" backupextension=".custom" failonerror="false" />
      <copy-with-backup olddir="${rhq.agent.update.update-agent-dir}/conf"
                        newdir="${_update.tmp.dir}/rhq-agent/conf"
                        filename="log4j.xml" keep="new" backupextension=".custom" failonerror="false" />

      <!-- everything is done; _update.tmp.dir/rhq-agent has our new agent -->
      <!-- the old agent is still intact, albeit with a new update subdirectory with the new agent in it -->
      <!-- start moving things around to get the new agent in the old agent's directory -->
      <!-- if anything fails below, bad things will happen because the old agent will be ruined -->
      <property name="new.location.for.old.agent" location="${rhq.agent.update.update-agent-dir}/../rhq-agent-OLD" />
      <delete dir="${new.location.for.old.agent}" /> <!-- in case there was a previous update's backup in here -->
      <move file="${rhq.agent.update.update-agent-dir}"
            tofile="${new.location.for.old.agent}"
            failonerror="true"/>
      <delete dir="${rhq.agent.update.update-agent-dir}" /> <!-- just trying to clear the way for the new agent -->
      <move file="${new.location.for.old.agent}/${_update.tmp.dir.name}/rhq-agent"
            tofile="${rhq.agent.update.update-agent-dir}"
            failonerror="true"/>
      <delete dir="${new.location.for.old.agent}/${_update.tmp.dir.name}" />

      <!-- at this point, the new agent should now be at the old agent's location -->
      <!-- the old agent is backed up to the rhq-agent-OLD directory next to new agent -->

      <!-- let's try to get our +x execute permissions back -->
      <chmod dir="${rhq.agent.update.update-agent-dir}/bin" perm="ug+rx" includes="*.sh"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.s0"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.sl"/>
      <chmod dir="${rhq.agent.update.update-agent-dir}/lib" perm="ug+rx" includes="*.dylib"/>

      <!-- agent is updated, we don't need the backup anymore, so remove it -->
      <delete dir="${java.io.tmpdir}/rhq-agent-update-backup" failonerror="false" verbose="false"/>

   </target>

   <!-- makes sure the jar file where the agent distro is supposed to be actually exists -->
   <target name="verify">
      <fail message="Could not determine the location of the jar file or it does not exist: ${rhq.agent.update.jar-file}">
         <condition>
            <not>
               <available file="${rhq.agent.update.jar-file}" />
            </not>
         </condition>
      </fail>
   </target>

   <!-- header targets will simply output some information to the console -->
   <target name="header" depends="header-for-update, header-for-install">
   </target>

   <target name="header-for-update" if="rhq.agent.update.update-flag">
      <echo>
===== RHQ AGENT UPDATE =====
Agent To Be Updated: ${rhq.agent.update.update-agent-dir}
Version: ${rhq-agent.latest.version}
Build Number: ${rhq-agent.latest.build-number}
Jar File: ${rhq.agent.update.jar-file}
</echo>
   </target>

   <target name="header-for-install" unless="rhq.agent.update.update-flag">
      <echo>
===== RHQ AGENT INSTALL =====
Installing Agent To: ${rhq.agent.update.install-agent-dir}
Version: ${rhq-agent.latest.version}
Build Number: ${rhq-agent.latest.build-number}
Jar File: ${rhq.agent.update.jar-file}
</echo>
   </target>
</project>