<plugin name="apache">

  <!-- defined by MeasurementPlugin
  <property name="url.config"
	    value=""/>
  -->

  <!-- defined by SNMPMeasurementPlugin
  <property name="snmp.config"
	    value=""/>
  -->

  <!-- first part of snmpIndexValue (1.3.6.1.2.1.6.)
       is the tcp protocol id, see ietf-mibs/WWW-MIB.txt -->
  <filter name="vhost.config"
	  value="snmpVarType=index,snmpIndexName=wwwServiceName->wwwServiceProtocol,snmpIndexValue=%server.name%->1.3.6.1.2.1.6.%port%"/>

  <!-- we need to lookup the index first, then combine that value
       with the give oid value.  for example:
         .....wwwResponseOutResponses.1.401
       where:
        wwwResponseOutResponses = snmpVarName
        1                       = snmpIndexValue (after the lookup)
        401                     = snmpOID
   -->
  <filter name="oid.config"
          value="${vhost.config},snmpVarType=oid,snmpOID"/>

  <!-- start properties generated by helpers/rr_metrics.pl -->

  <filter name="wwwRequestInBytes"
          value="${snmp.config}:wwwRequestInBytes:${oid.config}"/>

  <filter name="wwwRequestInRequests"
          value="${snmp.config}:wwwRequestInRequests:${oid.config}"/>

  <filter name="wwwResponseOutBytes"
          value="${snmp.config}:wwwResponseOutBytes:${oid.config}"/>

  <filter name="wwwResponseOutResponses"
          value="${snmp.config}:wwwResponseOutResponses:${oid.config}"/>

  <filter name="BASELINE_CONTROL"
          value="16.66.65.83.69.76.73.78.69.95.67.79.78.84.82.79.76"/>

  <filter name="CHECKIN"
          value="7.67.72.69.67.75.73.78"/>

  <filter name="CHECKOUT"
          value="8.67.72.69.67.75.79.85.84"/>

  <filter name="CONNECT"
          value="7.67.79.78.78.69.67.84"/>

  <filter name="COPY"
          value="4.67.79.80.89"/>

  <filter name="DELETE"
          value="6.68.69.76.69.84.69"/>

  <filter name="GET"
          value="3.71.69.84"/>

  <filter name="HEAD"
          value="4.72.69.65.68"/>

  <filter name="LABEL"
          value="5.76.65.66.69.76"/>

  <filter name="LOCK"
          value="4.76.79.67.75"/>

  <filter name="MERGE"
          value="5.77.69.82.71.69"/>

  <filter name="MKACTIVITY"
          value="10.77.75.65.67.84.73.86.73.84.89"/>

  <filter name="MKCOL"
          value="5.77.75.67.79.76"/>

  <filter name="MKWORKSPACE"
          value="11.77.75.87.79.82.75.83.80.65.67.69"/>

  <filter name="MOVE"
          value="4.77.79.86.69"/>

  <filter name="OPTIONS"
          value="7.79.80.84.73.79.78.83"/>

  <filter name="PATCH"
          value="5.80.65.84.67.72"/>

  <filter name="POST"
          value="4.80.79.83.84"/>

  <filter name="PROPFIND"
          value="8.80.82.79.80.70.73.78.68"/>

  <filter name="PROPPATCH"
          value="9.80.82.79.80.80.65.84.67.72"/>

  <filter name="PUT"
          value="3.80.85.84"/>

  <filter name="REPORT"
          value="6.82.69.80.79.82.84"/>

  <filter name="TRACE"
          value="5.84.82.65.67.69"/>

  <filter name="UNCHECKOUT"
          value="10.85.78.67.72.69.67.75.79.85.84"/>

  <filter name="UNLOCK"
          value="6.85.78.76.79.67.75"/>

  <filter name="UPDATE"
          value="6.85.80.68.65.84.69"/>

  <filter name="VERSION_CONTROL"
          value="15.86.69.82.83.73.79.78.95.67.79.78.84.82.79.76"/>

  <!-- end properties generated by helpers/rr_metrics.pl -->

  <!-- start metrics generated by helpers/rr_metrics.pl -->
  <metrics name="request-response-metrics">
    <metric name="Bytes Received for GET Requests"
            alias="InBytesGET"
            template="${wwwRequestInBytes}=${GET}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="true"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Received for HEAD Requests"
            alias="InBytesHEAD"
            template="${wwwRequestInBytes}=${HEAD}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Received for POST Requests"
            alias="InBytesPOST"
            template="${wwwRequestInBytes}=${POST}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="true"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Received for PUT Requests"
            alias="InBytesPUT"
            template="${wwwRequestInBytes}=${PUT}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Number of GET Requests"
            alias="InRequestsGET"
            template="${wwwRequestInRequests}=${GET}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of HEAD Requests"
            alias="InRequestsHEAD"
            template="${wwwRequestInRequests}=${HEAD}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="false"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of POST Requests"
            alias="InRequestsPOST"
            template="${wwwRequestInRequests}=${POST}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of PUT Requests"
            alias="InRequestsPUT"
            template="${wwwRequestInRequests}=${PUT}"
            category="THROUGHPUT"
            group="Request"
            defaultOn="false"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 200 Responses"
            alias="OutBytes200"
            template="${wwwResponseOutBytes}=200"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 301 Responses"
            alias="OutBytes301"
            template="${wwwResponseOutBytes}=301"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 302 Responses"
            alias="OutBytes302"
            template="${wwwResponseOutBytes}=302"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 401 Responses"
            alias="OutBytes401"
            template="${wwwResponseOutBytes}=401"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 403 Responses"
            alias="OutBytes403"
            template="${wwwResponseOutBytes}=403"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 404 Responses"
            alias="OutBytes404"
            template="${wwwResponseOutBytes}=404"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Bytes Sent for 500 Responses"
            alias="OutBytes500"
            template="${wwwResponseOutBytes}=500"
            category="THROUGHPUT"
            group="Response"
            defaultOn="false"
            indicator="false"
            units="B"
            collectionType="trendsup"/>
    <metric name="Number of 200 Responses"
            alias="OutResponses200"
            template="${wwwResponseOutResponses}=200"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 301 Responses"
            alias="OutResponses301"
            template="${wwwResponseOutResponses}=301"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 302 Responses"
            alias="OutResponses302"
            template="${wwwResponseOutResponses}=302"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 401 Responses"
            alias="OutResponses401"
            template="${wwwResponseOutResponses}=401"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 403 Responses"
            alias="OutResponses403"
            template="${wwwResponseOutResponses}=403"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 404 Responses"
            alias="OutResponses404"
            template="${wwwResponseOutResponses}=404"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number of 500 Responses"
            alias="OutResponses500"
            template="${wwwResponseOutResponses}=500"
            category="THROUGHPUT"
            group="Response"
            defaultOn="true"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
  </metrics>
  <!-- end metrics generated by helpers/rr_metrics.pl -->

  <!-- the vhost metrics also apply to the "main" server -->
  <!-- XXX or should the main server only provide totals
       (no url.config would be asked for)
       and the "main" port be configured as a vhost? -->

  <metrics name="apache-vhost" include="request-response-metrics">
    <metric name="Availability"
            alias="Availability"
            template="${url.config}:availability"
            category="AVAILABILITY"
            group="Reliability"
            defaultOn="true"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>

    <metric name="Total Number of Bytes Received"
            alias="InLowBytes"
            template="${snmp.config}:wwwSummaryInLowBytes:${vhost.config}"
            category="THROUGHPUT"
            group="Throughput"
            defaultOn="true"
            indicator="true"
            units="B"
            collectionType="trendsup"/>

    <metric name="Total Number of Bytes Sent"
            alias="OutLowBytes"
            template="${snmp.config}:wwwSummaryOutLowBytes:${vhost.config}"
            category="THROUGHPUT"
            group="Throughput"
            defaultOn="true"
            indicator="true"
            units="B"
            collectionType="trendsup"/>

    <metric name="Total Number of Requests"
            alias="InRequests"
            template="${snmp.config}:wwwSummaryInRequests:${vhost.config}"
            category="THROUGHPUT"
            group="Throughput"
            defaultOn="true"
            indicator="true"
            units="none"
            collectionType="trendsup"/>

    <metric name="Total Number of Responses"
            alias="OutResponses"
            template="${snmp.config}:wwwSummaryOutResponses:${vhost.config}"
            category="THROUGHPUT"
            group="Throughput"
            defaultOn="true"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
  </metrics>

  <metrics name="apache-server" include="apache-vhost">
    <metric name="Number of Concurrent Connections"
            alias="InboundAssociations"
            template="${snmp.config}:applInboundAssociations:snmpVarType=next"
            category="UTILIZATION"
            group="Resource Utilization"
            defaultOn="true"
            indicator="true"
            units="none"
            collectionType="dynamic"/>

    <metric name="Start Time"
            alias="StartTime"
            template="${snmp.config}:wwwServiceStartTime:${vhost.config}"
            category="AVAILABILITY"
            group="Reliability"
            defaultOn="true"
            indicator="false"
            units="epoch-millis"
            collectionType="static"/>
  </metrics>

  <help name="restart-server">
  <![CDATA[
    <p><h4>Restart the Server</h4></p>
    <pre>
    % ${program} restart
    </pre>
  ]]>
  </help>

  <help name="Apache 1.3 VHost" append="restart-server">
  <![CDATA[
    <p>
    <h3>Response Time Setup</h3>
    <h4>Compile and install the plugin:</h4>
    </p>
    <pre>
    % tar -zxf agent-${HQVersion}/product_connectors/rt-${HQVersion}.tgz
    % cd rt-${HQVersion}
    % ./build_apache_module.sh 1.3 ${installpath}/bin/apxs
    % cp apache1.3/unix/mod_rt.so ${installpath}/libexec
    </pre>
    <p><h4>Edit ${installpath}/conf/httpd.conf, adding:</h4></p>
    <pre>
    LoadModule rt_module libexec/mod_rt.so

    RtLog      logs/rt_log
    EndUserLog logs/enduser
    </pre>
  ]]>
  </help>

  <help name="Apache 2.0 VHost" append="restart-server">
  <![CDATA[
    <p>
    <h3>Response Time Setup</h3>
    <h4>Compile and install the plugin:</h4>
    </p>
    <pre>
    % tar -zxf agent-${HQVersion}/product_connectors/rt-${HQVersion}.tgz
    % cd rt-${HQVersion}
    % ./build_apache_module.sh 2.0 ${installpath}/bin/apxs
    % cp apache2.0/unix/.libs/mod_rt.so ${installpath}/modules
    </pre>
    <p><h4>Edit ${installpath}/conf/httpd.conf, adding:</h4></p>
    <pre>
    LoadModule rt_module modules/mod_rt.so

    LogFormat "%S" rt_log
    LogFormat "%R" enduser
    CustomLog logs/rt_log  rt_log
    CustomLog logs/enduser enduser
    </pre>
  ]]>
  </help>

  <help name="Apache 2.0 VHost Win32">
  <![CDATA[
    <p>
    <h3>Response Time Setup</h3>
    <h4>Edit ${installpath}\conf\httpd.conf, adding:</h4>
    </p>
    <pre>
    LoadModule rt_module modules/mod_rt.so

    LogFormat "%S" rt_log
    CustomLog logs/rt_log  rt_log
    </pre>
    <p>
    <h4>Restart the Server</h4>
    </p>
  ]]>
  </help>

  <help name="Apache-ERS 2.3 VHost" include="Apache 2.0 VHost"/>
  <help name="Apache-ERS 2.4 VHost" include="Apache-ERS 2.3 VHost"/>

  <help name="test-snmp">
  <![CDATA[
    <p><h4>Test SNMP</h4></p>
    <pre>
    % snmp_module_${product.version}/tools/snmpwalk -p ${snmpPort} -M snmp_module_${product.version}/mibs ${snmpIp} ${snmpCommunity}
    </pre>
  ]]>
  </help>

  <help name="Apache 1.3" append="restart-server,test-snmp">
  <![CDATA[
    <p>
    <h4>Compile and install the SNMP plugin:</h4>
    <b>NOTE:</b> Apache build must be configured with shared module support
   (--enable-module=so).
    </p>
    <pre>
    % tar -zxf agent-${HQVersion}/product_connectors/snmp-${HQVersion}.tgz
    % cd snmp-${HQVersion}
    % ./build_apache_snmp.sh 1.3 ${installpath}/bin/apxs
    % cp snmp_module_1.3/module/*.so ${installpath}/libexec
    % cp snmp_module_1.3/conf/snmpd.conf ${installpath}/conf
    % mkdir ${installpath}/var
    </pre>
    <p><h4>Edit ${installpath}/conf/httpd.conf, adding:</h4></p>
    <pre>
    LoadModule snmp_agt_module libexec/libsnmp_agt.so
    SNMPConf   conf
    SNMPVar    var
    </pre>
    <p>
    <h4>If the ClearModuleList directive is in your config file, 
        you will need to add:</h4>
    </p>
    <pre>
    AddModule covalent-snmp-v13.c
    </pre>
  ]]>
  </help>

  <help name="Apache 2.0" append="restart-server,test-snmp">
  <![CDATA[
    <p>
    <h4>Compile and install the SNMP plugin:</h4>
    NOTE: Apache build must be configured with shared module support
    (--enable-so).
    </p>
    <pre>
    % tar -zxf agent-${HQVersion}/product_connectors/snmp-${HQVersion}.tgz
    % cd snmp-${HQVersion}
    % ./build_apache_snmp.sh -r 2.0 ${installpath}/bin/apxs
    % cp snmp_module_2.0/module/*.so ${installpath}/modules
    % cp snmp_module_2.0/conf/snmpd.conf ${installpath}/conf
    % mkdir ${installpath}/var
    </pre>
    <p><h4>Edit ${installpath}/conf/httpd.conf, adding:</h4></p>
    <pre>
    LoadModule snmpcommon_module modules/libsnmpcommon.so
    LoadModule snmpagt_module modules/libsnmpmonagt.so
    SNMPConf   conf
    SNMPVar    var
    </pre>
    <p>
    <h4>Add Port to ServerName directives</h4>
    For example:
    </p>
    <pre>
    ServerName ${server.name}:${port}
    </pre>
  ]]>
  </help>

  <help name="Apache 2.0 Win32">
  <![CDATA[
    <p>
    <h4>Install the SNMP plugin:</h4>
    Extract agent-${HQVersion}\product_connectors\apache-2.0-x86-winnt.zip
    to ${installpath}.  Which will create the following:
    </p>
    <pre>
    modules\snmpcommon.so
    modules\snmpmonagt.so
    modules\mod_rt.so
    conf\snmpd.conf
    var\ 
    </pre>
    <p><h4>Edit ${installpath}\conf\httpd.conf, adding:</h4></p>
    <pre>
    LoadModule snmpcommon_module modules/snmpcommon.so
    LoadModule snmpagt_module modules/snmpmonagt.so
    SNMPConf   conf
    SNMPVar    var
    </pre>
    <p>
    <h4>Add Port to ServerName directives</h4>
    For example:
    </p>
    <pre>
    ServerName ${server.name}:${port}
    </pre>
    <p><h4>Restart the Server</h4></p>
  ]]>
  </help>

  <server name="Apache"
          description="Web Server"
          version="1.3"
          platforms="Unix,Win32">

    <property name="DEFAULT_CONF"
              value="conf/httpd.conf"/>

    <property name="DEFAULT_LOG_FILE"
              value="logs/error_log"/>

    <config include="url">
      <option name="server.name"
              description="Apache ServerName"/>
    </config>
    <config include="snmp" type="measurement">
      <!-- override default port -->
      <option name="snmpPort"
              type="port"
              default="1610"
              description="Apache SNMP Port"/>
    </config>

    <properties>
       <property name="version"
                 description="Apache Version"/>
       <property name="exe"
                 description="Server Executable"/>
       <property name="serverTokens"
                 description="Server Tokens"/>
       <property name="built"
                 description="Server Built"/>
       <property name="serverAdmin"
                 description="Server Admin"/>
    </properties>

    <plugin type="autoinventory"
            class="ApacheServerDetector"/>

    <plugin type="measurement"
            class="ApacheMeasurementPlugin"/>

    <plugin type="log_track"
            class="ApacheErrorLogPlugin"/>

    <plugin type="config_track"
            class="ApacheConfigTrackPlugin"/>

    <plugin type="control"
            class="ApacheControlPlugin"/>

    <actions include="start,stop,restart,graceful,startssl,configtest"/>

    <plugin type="control"
            platform="Win32"
            class="net.hyperic.hq.product.Win32ControlPlugin"/>

    <actions platform="Win32"
             include="start,stop,restart"/>

    <config type="control" platform="Win32">
      <option name="service_name"
              default="Apache2"
              description="Apache Service Name"/>
    </config>

    <metrics include="apache-server"/>

    <scan>
      <include name="/**/bin/httpd"/>
      <include name="/**/bin/httpsd"/>
      <include name="/**/bin/apache"/>
      <include name="/**/bin/apache2"/>
      <include name="/**/sbin/httpd"/>
      <include name="/**/sbin/httpsd"/>
      <include name="/**/sbin/apache"/>
      <include name="/**/sbin/apache2"/>
    </scan>

    <service name="VHost">
      <config include="url">
        <option name="server.name"
                description="Apache ServerName"/>
      </config>

      <plugin type="responsetime"
              class="ApacheRtPlugin"/>

      <plugin type="log_track"
              class="ApacheErrorLogPlugin"/>

      <metrics include="apache-vhost"/>
    </service>
  </server>

  <server name="Apache"
          version="2.0"
          include="1.3">

    <plugin type="autoinventory"
            class="Apache20ServerDetector"/>

    <scan registry="SOFTWARE\Apache Group\Apache\2.*">
      <include name="ServerRoot"/>
    </scan>

    <properties>
       <property name="mpm"
                 description="Server MPM"/>
    </properties>
  </server>

  <server name="Apache-ERS"
          version="2.3"
          include="Apache 2.0">

    <help/>

    <plugin type="autoinventory"
            class="ErsApacheServerDetector"/>

    <plugin type="control"
            class="ErsApacheControlPlugin"/>

    <scan>
      <include name="/**/*ers*2*3*/tools/lib/covalent.ico"/>
    </scan>

    <scan registry="SYSTEM\CurrentControlSet\Services\Covalent*">
      <include name="ImagePath"/>
    </scan>
  </server>

  <server name="Apache-ERS"
          version="2.4"
          include="2.3">

    <property name="DEFAULT_SCRIPT"
              value="bin/apache_startup.sh"/>

    <property name="DEFAULT_PIDFILE"
              value="logs/httpsd.pid"/>

    <property name="DEFAULT_CONF"
              value="conf/httpsd.conf"/>

    <property name="DEFAULT_LOG_FILE"
              value="logs/error.log"/>

    <property name="VERSION_FILE"
              value="tools/lib/covalent.ico"/>

    <scan>
      <include name="/**/${VERSION_FILE}"/>
    </scan>
  </server>

  <server name="Apache-ERS"
          version="3.x"
          include="2.4">

    <property name="VERSION_FILE"
              value="tools/bin/openssl"/>
    <scan>
      <include name="/**/${VERSION_FILE}"/>
    </scan>
  </server>
</plugin>
