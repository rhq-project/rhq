<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE plugin [

        <!ENTITY logSources '
    <c:group name="event" displayName="Events">
        <c:list-property name="logEventSources">
            <c:map-property name="logEventSource">
                <c:simple-property name="logFilePath" type="file" summary="true"
                                   description="The absolute path to the source log file."/>
                <c:simple-property name="enabled" type="boolean" summary="true"
                                   description="A flag indicating whether of not this log Event source is currently
                                                enabled (i.e. whether the associated log file should be tailed for
                                                new entries)."/>
                <c:simple-property name="dateFormat" required="false"
                                   description="The date format to use when parsing the dates in log entries. The
                                                format must be in the syntax defined by the Java SimpleDateFormat
                                                class. If not specified, the three date formats that are predefined
                                                by Log4J (ISO8601, DATE, and ABSOLUTE) will be tried."/>
                <c:simple-property name="includesPattern" required="false"
                                   description="A regular expression against which a log entrys detail is matched
                                                to determine if an Event should be fired for that entry. If not
                                                specified, no filtering of log entries will be done based on their
                                                detail."/>
                <c:simple-property name="minimumSeverity" required="false" default="error"
                                   description="The minimum severity of Events that should be collected for this
                                                source. If not specified, there is no minimum severity (i.e. all
                                                events will be collected).">
                    <c:property-options>
                       <c:option name="debug" value="debug"/>
                       <c:option name="info"  value="info"/>
                       <c:option name="warn"  value="warn"/>
                       <c:option name="error" value="error"/>
                       <c:option name="fatal" value="fatal"/>
                    </c:property-options>
                </c:simple-property>
            </c:map-property>
        </c:list-property>
    </c:group>
'>

        ]>

<plugin name="jboss-as-7"
        displayName="JBoss-AS-7-Plugin"
        description="Management of JBossAS 7"
        package="org.rhq.modules.plugins.jbossas7"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="urn:xmlns:rhq-plugin"
        xmlns:c="urn:xmlns:rhq-configuration"
        version="4.0.0-SNAPSHOT"
        >

<!--    <depends plugin="JMX" useClasses="true"/> -->


    <!-- TODO I think we should introduce an abstract AS7 plugin that contains some base functionality and then
      ~~      additional 'Personalities' for the kinds of servers (PM, SM, Standalone AS, Managed AS)
      -->

    <server name="ProcessController"
            discovery="BaseProcessDiscovery"
            class="BaseComponent"
            description="Reaper process for other AS7 servicees"
            >

        <plugin-configuration>
            <c:simple-property name="hostname" default="localhost" required="true"/>
            <c:simple-property name="port" default="9990" type="integer" required="true"/>

            &logSources;
        </plugin-configuration>

        <process-scan name="ProcessController" query="process|basename|match=^java.*,arg|org.jboss.as.process-controller|match=.*"/>


        <operation name="dummyOperation">
            <!-- TODO supply parameters and return values -->
        </operation>


    </server>
    <server name="HostController"
            discovery="BaseProcessDiscovery"
            class="BaseComponent"
            description="Domain controller (delegate) for this host"
            >

        <plugin-configuration>
            <c:simple-property name="hostname" default="localhost" required="true"/>
            <c:simple-property name="port" default="9990" type="integer" required="true"/>

            &logSources;
        </plugin-configuration>

        <process-scan name="HostController" query="process|basename|match=^java.*,arg|org.jboss.as.host-controller|match=.*"/>


        <operation name="shutdown" description="Shut this Host-/Domaincontroller down with all managed servers.">
        </operation>


    </server>

    <server name="Domain"
            discovery="DomainDiscovery"
            class="DomainComponent"
            description="An AS7 management profile">

        <subcategories>
            <subcategory name="Integration" />
            <subcategory name="Core"/>
            <subcategory name="Web"/>
        </subcategories>

        <plugin-configuration>
            <c:simple-property name="hostname" default="localhost" displayName="Management host" required="true"/>
            <c:simple-property name="port" default="9990" type="integer" displayName="Management port" required="true"/>
        </plugin-configuration>

        <!-- Scan for host controller is intentional -->
        <process-scan name="HostController" query="process|basename|match=^java.*,arg|org.jboss.as.host-controller|match=.*"/>


        <operation name="server-group:add" displayName="Add ServerGroup" description="Add a server group to the Domain.">
            <parameters>
                <c:simple-property name="name" description="Name of Group to add"/>
                <c:simple-property name="profile" description="Profile to add this group to"/>
            </parameters>
        </operation>
        <operation name="server-group:remove" displayName="Remove ServerGroup" description="Remove a server group from the Domain.">
            <parameters>
                <c:simple-property name="name" description="Name of Group to add"/>
            </parameters>
        </operation>
        <operation name="managed-server:add" displayName="Add managed server" description="Add a new managed server">
            <parameters>
                <c:simple-property name="servername" displayName="Name of the new server" required="true"/>
                <c:simple-property name="hostname" displayName="Name of the host to put the server on" required="true"/>
                <c:simple-property name="server-group" displayName="Server group to add to" required="true"/>
                <c:simple-property name="socket-bindings" displayName="Socket bindings to base upon" default="standard-sockets" description="Socket bindings to base upon"/>
                <c:simple-property name="port-offset" displayName="Port offset" default="0" type="integer" />
                <c:simple-property name="auto-start" displayName="Autostart" default="false" type="boolean" />
            </parameters>
            <results>
                <c:simple-property name="result" description="Outcome of the create server operation"/>
            </results>
        </operation>
        <operation name="managed-server:remove" displayName="Remove managed server" description="Remove a managed server">
            <parameters>
                <c:simple-property name="servername" displayName="Name of the server to remove" required="true"/>
                <c:simple-property name="hostname" displayName="Name of the host where the server is on" required="true"/>
            </parameters>
            <results>
                <c:simple-property name="result" description="Outcome of the remove server operation"/>
            </results>

        </operation>


        <server name="Profile"
                description="One profile in a domain"
                discovery="SubsystemDiscovery"
                class="BaseComponent">

            <plugin-configuration>
                <c:simple-property name="path" default="profile" readOnly="true"/>
            </plugin-configuration>
        </server>
        <server name="ServerGroup"
                description="Server groups on this domain"
                discovery="SubsystemDiscovery"
                class="ServerGroupComponent"
                >
            <!-- TODO move operation to createDeletePolicy="create-only" -->

            <plugin-configuration>
                <c:simple-property name="path" default="server-group" readOnly="true"/>
            </plugin-configuration>


            <content name="deployment" category="deployable" isCreationType="true" description="Deployments on this domain">
            </content>

            <resource-configuration>
                <c:simple-property name="profile" />
                <c:simple-property name="socket-binding-group"/>
                <c:simple-property name="jvm" required="false"/>
            </resource-configuration>

            <service name="Deployment"
                     class="BaseComponent"
                     discovery="SubsystemDiscovery"
                     createDeletePolicy="both"
                     creationDataType="content">
                <plugin-configuration>
                    <c:simple-property name="path" default="deployment" readOnly="true"/>
                </plugin-configuration>

                <content name="file" category="deployable" isCreationType="true" description="Deployments on this domain">
                    <configuration>
                       <c:group name="deployment" displayName="Deployment Options">
                           <c:simple-property name="runtimeName" required="true"/>
                           <c:simple-property name="alreadyUploaded" type="boolean" description="Was this already uploaded to the Domain? TODO"/>
                       </c:group>
                    </configuration>
                </content>

            </service>
        </server>
        <server name="Host"
                description="Host involved in this domain"
                discovery="SubsystemDiscovery"
                class="DomainComponent"
                >
            <plugin-configuration>
                <c:simple-property name="path" default="host" readOnly="true"/>
            </plugin-configuration>

            <operation name="server:add" displayName="Create server" description="Add a new server to this host.">
                <parameters>
                    <c:simple-property name="name" description="Name of this new server" required="true"/>
                    <c:simple-property name="group" displayName="Server Group" description="Server group to put this sever in" default="" required="false"/>
                    <c:simple-property name="auto-start" displayName="Autostart" description="Should this server start at boot?" type="boolean" default="false" required="true"/>
                </parameters>
                <results>
                    <c:simple-property name="result" description="Outcome of the create server operation"/>
                </results>
            </operation>
            <operation name="server:remove" displayName="Delete server" description="Deletes a server on this host.">
                <parameters>
                    <c:simple-property name="name" description="Name of this new server" required="true"/>
                </parameters>
                <results>
                    <c:simple-property name="result" description="Outcome of the delete server operation"/>
                </results>
            </operation>
        </server>

        <service name="DomainDeployment"
                 class="BaseComponent"
                 discovery="SubsystemDiscovery"
                 createDeletePolicy="both"
                 creationDataType="content">
            <plugin-configuration>
                <c:simple-property name="path" default="deployment" readOnly="true"/>
            </plugin-configuration>

            <content name="file" category="deployable" isCreationType="true" description="Deployments on this domain">
            </content>

            <resource-configuration>
                <c:simple-property name="name" readOnly="true"/>
                <c:simple-property name="runtime-name" readOnly="true"/>
                <c:simple-property name="hash" readOnly="true"/>
            </resource-configuration>
        </service>
    </server>

    <server name="JBossAS7-Standalone"
            discovery="BaseProcessDiscovery"
            class="BaseComponent"
            >

        <plugin-configuration>
            <c:simple-property name="hostname" default="localhost" required="true"/>
            <c:simple-property name="port" default="9990" type="integer" required="true"/>
            <c:list-property name="system-properties">
                <c:map-property name="system-property">
                    <c:simple-property name="key" readOnly="true"/>
                    <c:simple-property name="value" readOnly="true"/>
                </c:map-property>
            </c:list-property>
            &logSources;
        </plugin-configuration>

        <process-scan name="StandaloneAS" query="process|basename|match=^java.*,arg|org.jboss.as.standalone|match=.*"/>


        <resource-configuration>
            <c:list-property name="schema-locations" displayName="Schema locations">
                <c:map-property name="location">
                    <c:simple-property name="urn" readOnly="true"/>
                    <c:simple-property name="location" readOnly="true"/>
                </c:map-property>
            </c:list-property>
            <c:list-property name="extension" displayName="Installed extensions">
                <c:simple-property name="name" readOnly="true"/>
            </c:list-property>
        </resource-configuration>



    </server>

    <server name="JBossAS-Managed"
            discovery="ManagedASDiscovery"
            class="DomainComponent"
            >
        <plugin-configuration>
            <c:simple-property name="hostname" default="localhost" displayName="Management host" required="true"/>
            <c:simple-property name="port" default="9990" type="integer" displayName="Management port" required="true"/>
            <c:simple-property name="domainHost" readOnly="true" description="Hostname in the domain"/>
            <c:simple-property name="group" readOnly="true" displayName="Server Group" description="Server Group this instance belongs to."/>
            <c:simple-property name="socket-binding-group" readOnly="true" displayName="Socket binding group" description="Socket bindngs to use"/>
            <c:simple-property name="socket-binding-port-offset" readOnly="true" displayName="Port Offset" type="integer" default="0" description="Offset to the base ports"/>

            &logSources;
        </plugin-configuration>

        <!-- Scan for host controller is intentional -->
        <process-scan name="HostController" query="process|basename|match=^java.*,arg|org.jboss.as.host-controller|match=.*"/>
        <process-scan name="ManagedAS" query="process|basename|match=^java.*,arg|org.jboss.as.server|match=.*"/>

        <operation name="server:start" description="Start this server instance." displayName="Start">
            <results>
                <c:simple-property name="operationResult"/>
            </results>
        </operation>
        <operation name="server:stop" description="Stop this server instance." displayName="Stop">
            <results>
                <c:simple-property name="operationResult"/>
            </results>
        </operation>
        <operation name="server:restart" description="Restart this server instance." displayName="Restart">
            <results>
                <c:simple-property name="operationResult"/>
            </results>
        </operation>



    </server>


<!--
    <server name="JBoss AS JVM"
            description="JVM of the standalone JBossAS"
            sourcePlugin="JMX"
            sourceType="JMX Server"
            discovery="org.rhq.plugins.jmx.LocalJMXServerDiscoveryComponent"
            class="org.rhq.plugins.jmx.JMXServerComponent"
            singleton="true"
    >
        <runs-inside>
            <parent-resource-type name="JBossAS-Managed"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
            <parent-resource-type name="ProcessController"  plugin="jboss-as-7"/>
        </runs-inside>
    </server>
-->

    <server name="Messaging"
            discovery="SubsystemDiscovery"
            class="DomainComponent"
            description="The underlying HornetQ based messaging subsystem"
            singleton="true"
            >
        <runs-inside>
            <parent-resource-type name="Profile"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>

        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="subsystem=messaging"/>
        </plugin-configuration>

        <operation name="destination:add" displayName="Add destination" description="Add a Queue or Topic">
            <parameters>
                <c:simple-property name="name" description="Name of the Destination" required="true"/>
                <c:simple-property name="queue-address" description="The queue address defines what address is used for routing messages." required="true"/>
                <c:simple-property name="type" description="Type of Destination to create" default="Queue">
                    <c:property-options>
                        <c:option value="Queue"/>
                        <c:option value="Topic"/>
                    </c:property-options>
                </c:simple-property>
                <c:simple-property name="filter" description="The queue message filter definition."/>
                <c:simple-property name="durable" description="Defines whether the queue is durable." type="boolean" default="false"/>
            </parameters>
            <results>
                <c:simple-property name="operationResult"/>
            </results>
        </operation>
        <operation name="destination:remove" displayName="Remove Destination" description="Remove a destination">
            <parameters>
                <c:simple-property name="name" description="Name of the Destination" required="true"/>
            </parameters>
            <results>
                <c:simple-property name="operationResult"/>
            </results>
        </operation>

        <resource-configuration>
            <c:simple-property name="journal-min-files" />
            <c:simple-property name="journal-type" />
        </resource-configuration>


        <service name="Acceptor"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="acceptor"/>
            </plugin-configuration>
        </service>
        <service name="MessagingConnector"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="connector"/>
            </plugin-configuration>
        </service>
        <service name="HQueue"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="queue"/>
            </plugin-configuration>
            <resource-configuration>
                <c:simple-property name="queue-address" required="true"/>
                <c:simple-property name="filter" />
                <c:simple-property name="durable" type="boolean"/>
            </resource-configuration>

        </service>
    </server>

    <server name="JMS"
            discovery="SubsystemDiscovery"
            class="DomainComponent"
            description="The JMS messaging subsystem"
            singleton="true"
            >
        <runs-inside>
            <parent-resource-type name="Profile"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>

        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="subsystem=jms"/>
        </plugin-configuration>

        <service name="Queue"
            discovery="SubsystemDiscovery"
            class="BaseComponent"
            >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="queue"/>
            </plugin-configuration>
        </service>
        <service name="Topic"
            discovery="SubsystemDiscovery"
            class="BaseComponent"
            >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="topic"/>
            </plugin-configuration>
        </service>
        <service name="Connection-Factory"
            discovery="SubsystemDiscovery"
            class="BaseComponent"
            >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="connection-factory"/>
            </plugin-configuration>
        </service>

    </server>

    <server name="JBossWeb"
            discovery="SubsystemDiscovery"
            class="BaseComponent"
            singleton="true"
            >

        <runs-inside>
            <parent-resource-type name="Profile"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>

        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="subsystem=web"/>
        </plugin-configuration>

        <service name="Connector"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                >
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="connector"/>
            </plugin-configuration>


            <metric property="bytesSent" measurementType="trendsup"/>
            <metric property="bytesReceived" measurementType="trendsup"/>
            <metric property="processingTime" measurementType="trendsup"/>
            <metric property="errorCount" measurementType="trendsup" displayType="summary"/>
            <metric property="maxTime" />
            <metric property="requestCount" measurementType="trendsup" displayType="summary"/>

            <resource-configuration>
                <c:simple-property name="protocol" required="false" description="The web connector protocol."/>
                <c:simple-property name="socket-binding" required="false" description="The web connector socket-binding reference, this connector should be bound to."/>
                <c:simple-property name="scheme" required="false" description="The web connector scheme"/>
            </resource-configuration>

        </service>

        <service name="VHost"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent">
            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="virtual-server"/>
            </plugin-configuration>

            <resource-configuration>
                <c:simple-property name="access-log"/>
                <c:list-property name="alias" description="The virtual server aliases">
                    <c:simple-property name="alias"/>
                </c:list-property>
                <c:simple-property name="rewrite"/>
            </resource-configuration>

        </service>


    </server>

    <server name="Datasources"
            discovery="SubsystemDiscovery"
            class="BaseComponent"
            singleton="true"
            >

        <runs-inside>
            <parent-resource-type name="Profile"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>

        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="subsystem=datasources"/>
        </plugin-configuration>

        <service name="DataSource"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                 singleton="true"
                >

            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="data-source"/>
            </plugin-configuration>

            <resource-configuration>
                <c:map-property name="configuration">
                    <c:simple-property name="connection-url"/>
                    <c:simple-property name="driver-class"/>
                    <c:simple-property name="jndi-name"/>
                    <c:simple-property name="driver"/>
                    <c:simple-property name="pool-name"/>
                    <c:simple-property name="use-java-context" type="boolean"/>
                    <c:simple-property name="enabled" type="boolean"/>
                    <c:simple-property name="user-name"/>
                    <c:simple-property name="password"/>
                    <!-- TODO more when they become available in the AS -->
                </c:map-property>
            </resource-configuration>
        </service>

        <service name="XADataSource"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                 singleton="true"
                >

            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="xa-data-source"/>
            </plugin-configuration>
        </service>

        <service name="JdbcDriver"
                 discovery="SubsystemDiscovery"
                 class="BaseComponent"
                 singleton="true"
                >

            <plugin-configuration>
                <c:simple-property name="path" readOnly="true" default="jdbc-driver"/>
            </plugin-configuration>
        </service>

    </server>

    <service name="NetworkInterface"
             discovery="SubsystemDiscovery"
             class="BaseComponent"
             description="A named network interface, along with required criteria for determining the IP address to associate with that interface">

        <runs-inside>
            <parent-resource-type name="Domain"  plugin="jboss-as-7"/>
            <parent-resource-type name="Host"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>

        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="interface"/>
        </plugin-configuration>
    </service>

    <service name="SocketBindingGroup"
             discovery="SubsystemDiscovery"
             class="BaseComponent"
            >
        <runs-inside>
            <parent-resource-type name="Domain"  plugin="jboss-as-7"/>
            <parent-resource-type name="JBossAS7-Standalone"  plugin="jboss-as-7"/>
        </runs-inside>


        <plugin-configuration>
            <c:simple-property name="path" readOnly="true" default="socket-binding-group"/>
        </plugin-configuration>

        <resource-configuration>
            <c:simple-property name="default-interface" readOnly="true" displayName="Default Interface" description="Default Interface for these bindings. See NetworkInterfaces for its definition" required="false"/>
            <!-- note: at domain level there is no port-offset -->
            <c:simple-property name="port-offset" readOnly="true" displayName="Port Offset" description="Offset from standard ports for this group" required="false"/>
            <c:list-property name="include">
                <c:simple-property name="binding" displayName="Included bindings" description="Other bindings that are included in this one"/>
            </c:list-property>
            <c:list-property name="socket-binding">
                <c:map-property name="binding">
                    <c:simple-property name="name" description="The name of the socket. Services which need to access the socket configuration information will find it using this name."/>
                    <c:simple-property name="interface" description="Name of the interface to which the socket should be bound, or, for multicast sockets, the interface on which it should listen. This should be one of the declared interfaces." required="false"/>
                    <c:simple-property name="port" description="Number of the port to which the socket should be bound." type="integer"/>
                    <c:simple-property name="fixed-port" description="Whether the port value should remain fixed even if numeric offsets are applied to the other sockets in the socket group." type="boolean"/>
                    <c:simple-property name="multicast-address" description="Multicast address on which the socket should receive multicast traffic. If unspecified, the socket will not be configured to receive multicast." />
                    <c:simple-property name="multicast-port" description="Port on which the socket should receive multicast traffic. Must be configured if 'multicast-address' is configured." type="integer"/>
                </c:map-property>
            </c:list-property>
        </resource-configuration>

    </service>

</plugin>
